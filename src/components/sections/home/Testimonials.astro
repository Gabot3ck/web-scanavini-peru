---
import TestimonialCard from "../../layout/TestimonialCard.astro";
import { testimonials } from "../../../data/data-testimonials.ts";
import TitleOfSection from "../../layout/TitleOfSection.astro";
---

<section class="bg-neutral-dark min-h-[550px] 2xl:min-h-[900px] flex items-start justify-center py-10 md:py-12 xl:py-28 overflow-x-hidden">
  <div class="container-custom ">
    <!-- Heading -->
    <TitleOfSection 
      subtitle="¿QUÉ DICEN"
      subtitleColor="text-white"
      titleOfSection="NUESTROS CLIENTES?"
    />

    <div class="relative">
      <!-- Carousel Container -->
      <div id="carousel" class="relative flex items-center">
        <div class="carousel-container relative overflow-hidden h-auto xl:h-[500px]">
          <div
            class="carousel-track flex transition-transform duration-500 ease-in-out mt-5"
            id="testimonials-track"
          >
            {
              testimonials.map((testimonial, index) => {
                // card central sugerida por defecto cuando hay 3 visibles
                const isActiveCard = index === 1;
                return (
                  <TestimonialCard
                    name={testimonial.name}
                    company={testimonial.company}
                    testimonial={testimonial.testimonial}
                    rating={testimonial.rating}
                    isActive={isActiveCard}
                  />
                );
              })
            }
          </div>
        </div>
      </div>

      <!-- Controles externos: flechas + dots (fuera del área de cards) -->
      <div class="mt-10 flex items-center justify-center gap-6">
        <button
          id="prev"
          class="nav-button w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center text-gray-700 hover:bg-brand hover:text-white transition-all duration-300"
          aria-label="Testimonio anterior"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>

        <div class="flex items-center justify-center gap-3" id="indicators-container"></div>

        <button
          id="next"
          class="nav-button w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center text-gray-700 hover:bg-brand hover:text-white transition-all duration-300"
          aria-label="Siguiente testimonio"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</section>

<script>
  import { updateComponentStylesBySelector } from "../../../scripts/utils/updateComponentStylesBySelector";
  import { updateComponentStylesBySelectorAll } from "../../../scripts/utils/updateComponentStylesBySelectorAll";

  interface CarouselElements {
    track: HTMLElement;
    cards: NodeListOf<HTMLElement>;
    prevBtn: HTMLElement;
    nextBtn: HTMLElement;
    dots: NodeListOf<HTMLElement>;
    carousel: HTMLElement;
    images: NodeListOf<HTMLImageElement>;
  }

  class TestimonialsCarousel {
    private elements!: CarouselElements;
    private currentIndex: number = 0;        // se ajusta en init() según visibleCards
    private totalCards!: number;
    private visibleCards: number = 1;
    private cardWidth: number = 0;
    private maxIndex: number = 0;
    private minIndex: number = 0;
    private autoSlideInterval: number | null = null;
    private isTransitioning: boolean = false;

    constructor() {
      const track = document.getElementById("testimonials-track") as HTMLElement;
      const carousel = document.getElementById("carousel") as HTMLElement;
      // limitar query de imágenes y elementos al contenedor del carrusel
      const images = carousel.querySelectorAll("img") as NodeListOf<HTMLImageElement>;
      const cards = document.querySelectorAll(".testimonial-card") as NodeListOf<HTMLElement>;
      const prevBtn = document.getElementById("prev") as HTMLElement;
      const nextBtn = document.getElementById("next") as HTMLElement;
      const dots = document.querySelectorAll(".indicator-dot") as NodeListOf<HTMLElement>;

      if (!track || !cards || cards.length === 0 || !prevBtn || !nextBtn || !carousel || !images) {
        console.warn("Carousel elements not found");
        return;
      }

      this.elements = { track, cards, prevBtn, nextBtn, dots, carousel, images };
      this.totalCards = cards.length;

      this.init();
    }

    private init(): void {
      this.calculateDimensions();
      // índice inicial dentro del rango válido
      this.currentIndex = Math.min(Math.max(this.visibleCards >= 3 ? 1 : 0, this.minIndex), this.maxIndex);
      this.renderDots();

      this.setupEventListeners();
      this.updateCarousel();
      this.startAutoSlide();
      this.setupResponsiveListener();
    }

    private calculateDimensions(): void {
      const width = window.innerWidth;
      // Breakpoints del proyecto: sm=640, md=768, lg=960
      if (width >= 960) {
        this.visibleCards = 3;   // lg y arriba
      } else if (width >= 768) {
        this.visibleCards = 3;   // md
      } else if (width >= 640) {
        this.visibleCards = 2;   // sm
      } else {
        this.visibleCards = 1;   // < sm
      }

      if (this.elements.cards.length > 0) {
        const first = this.elements.cards[0];
        // Se usa el ancho real en píxeles (incluye padding) + márgenes si existieran
        const rect = first.getBoundingClientRect();
        const style = window.getComputedStyle(first);
        const ml = parseFloat(style.marginLeft) || 0;
        const mr = parseFloat(style.marginRight) || 0;
        this.cardWidth = rect.width + ml + mr;
      }

      // === Límite de índice según # de visibles ===
      if (this.visibleCards >= 3) {
        this.minIndex = Math.min(1, Math.max(0, this.totalCards - 1)); // 1 si hay >=2 cards
        this.maxIndex = Math.max(1, this.totalCards - 2);
      } else if (this.visibleCards === 2) {
        this.minIndex = this.totalCards > 2 ? 1 : 0;
        this.maxIndex = this.totalCards > 2 ? this.totalCards - 2 : 0;
      } else {
        this.minIndex = 0;
        this.maxIndex = Math.max(0, this.totalCards - 1);
      }
      // Clamp del índice activo al nuevo rango
      this.currentIndex = Math.min(Math.max(this.currentIndex, this.minIndex), this.maxIndex);
      // Re-renderizar dots si cambia el rango
      this.renderDots();
    }

    private setupEventListeners(): void {
      this.elements.prevBtn.addEventListener("click", () => {
        this.prevSlide();
        this.resetAutoSlide();
      });

      this.elements.nextBtn.addEventListener("click", () => {
        this.nextSlide();
        this.resetAutoSlide();
      });


      // Click/teclado en cards para activarlas
      this.elements.cards.forEach((card, index) => {
        card.addEventListener("click", () => {
          this.goToSlide(index);
          this.resetAutoSlide();
        });
        card.addEventListener("keydown", (e: KeyboardEvent) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            this.goToSlide(index);
            this.resetAutoSlide();
          }
        });
      });

      // pausa en hover
      this.elements.carousel.addEventListener("mouseenter", () => this.stopAutoSlide());
      this.elements.carousel.addEventListener("mouseleave", () => this.startAutoSlide());
    }

    private setupResponsiveListener(): void {
      window.addEventListener("resize", () => {
        this.calculateDimensions();
        this.updateCarousel();
      });
    }

    private nextSlide(): void {
      if (this.isTransitioning) return;
      this.currentIndex = Math.min(this.currentIndex + 1, this.maxIndex);
      this.updateCarousel();
    }

    private prevSlide(): void {
      if (this.isTransitioning) return;
      this.currentIndex = Math.max(this.currentIndex - 1, 0);
      this.updateCarousel();
    }

    private goToSlide(slideIndex: number): void {
      if (this.isTransitioning) return;
      const target = Math.max(0, Math.min(slideIndex, this.maxIndex));
      if (target === this.currentIndex) return;
      this.currentIndex = target;
      this.updateCarousel();
    }

    private updateCarousel(): void {
      this.isTransitioning = true;

      // offset para centrar según # de visibles
      let offset = 0;
      if (this.visibleCards === 3) {
        const centerPosition = this.currentIndex - 1;
        offset = -Math.max(0, Math.min(centerPosition, this.totalCards - this.visibleCards)) * (100 / this.visibleCards);
      } else if (this.visibleCards === 2) {
        const centerPosition = this.currentIndex - 0.5;
        offset = -Math.max(0, Math.min(centerPosition, this.totalCards - this.visibleCards)) * (100 / this.visibleCards);
      } else {
        offset = -this.currentIndex * 100;
      }



      this.elements.track.style.transform = `translateX(${offset}%)`;

      this.updateCardStates();
      this.updateDots();

      setTimeout(() => {
        this.isTransitioning = false;
      }, 500);
    }


    private renderDots(): void {            
      const container = document.getElementById("indicators-container");
      if (!container) return;
      container.innerHTML = "";

      // Cantidad real de posiciones válidas
      const count = this.maxIndex - this.minIndex + 1;
      for (let i = 0; i < count; i++) {
        const btn = document.createElement("button");
        btn.className = "indicator-dot w-3 h-3 rounded-full transition-all duration-300 bg-gray-300 hover:bg-gray-400";
        btn.setAttribute("aria-label", `Ir al testimonio ${i + 1}`);
        // Mapear dot i → índice activo real
        const targetIndex = this.minIndex + i;
        btn.dataset.slide = String(targetIndex);
        btn.addEventListener("click", () => {
          this.goToSlide(targetIndex);
          this.resetAutoSlide();
        });
        container.appendChild(btn);
      }
      // Actualiza referencia para updateDots()
      this.elements.dots = container.querySelectorAll(".indicator-dot") as NodeListOf<HTMLElement>;
    }


    private updateCardStates(): void {
      this.elements.cards.forEach((element, index) => {
        const cardContent = element.querySelector("div") as HTMLElement;
        const isActive = index === this.currentIndex;

        // aria-pressed para accesibilidad del botón-card
        element.setAttribute("aria-pressed", String(isActive));

        if (isActive) {
          // estilos de card activa
          cardContent.className = cardContent.className.replace(/bg-white|text-gray-800|border-gray-50/g, "");
          cardContent.classList.add(
            "bg-orange-500",
            "text-white",
            "border-orange-600",
            "shadow-xl",
            "transform",
            "-translate-y-4"
          );

          // Borde imagen
          updateComponentStylesBySelector(
            element,
            "border-3",
            ["border-orange-400", "bg-white"],
            ["border-white", "bg-orange-400"]
          );

          // Textos
          updateComponentStylesBySelector(element, "h3", ["text-gray-800"], ["text-white"]);
          updateComponentStylesBySelector(element, "p", ["text-gray-500"], ["text-orange-100"]);
          updateComponentStylesBySelector(element, ".italic", ["text-gray-600"], ["text-white"]);

          // Imagen sin filtro
          updateComponentStylesBySelectorAll(element, "img", ["grayscale"], ["grayscale-0"]);

          // Estrellas
          const stars = element.querySelectorAll("svg");
          stars.forEach((star, starIndex) => {
            const isFilled = starIndex < parseInt(element.getAttribute("data-rating") || "5");
            star.classList.remove("text-primary-400", "text-gray-300", "text-orange-200", "text-white");
            star.classList.add(isFilled ? "text-white" : "text-orange-200");
          });
        } else {
          // estilos card inactiva
          cardContent.className = cardContent.className.replace(
            /bg-orange-500|text-white|border-orange-600|shadow-xl|-translate-y-4/g,
            ""
          );
          cardContent.classList.add("bg-white", "text-gray-800", "border-gray-50");

          // Borde imagen reset
          updateComponentStylesBySelector(
            element,
            "border-3",
            ["border-white", "bg-orange-400"],
            ["border-orange-400", "bg-white"]
          );

          // Imagen con filtro
          updateComponentStylesBySelector(element, "img", ["grayscale-0"], ["grayscale"]);

          // Textos reset
          updateComponentStylesBySelector(element, "h3", ["text-white"], ["text-gray-800"]);
          updateComponentStylesBySelector(element, "p", ["text-orange-100"], ["text-gray-500"]);
          updateComponentStylesBySelector(element, ".italic", ["text-white"], ["text-gray-600"]);

          // Estrellas reset
          const stars = element.querySelectorAll("svg");
          stars.forEach((star, starIndex) => {
            const isFilled = starIndex < parseInt(element.getAttribute("data-rating") || "5");
            star.classList.remove("text-white", "text-orange-200", "text-primary-400", "text-gray-300");
            star.classList.add(isFilled ? "text-primary-400" : "text-gray-300");
          });
        }
      });
    }

    private updateDots(): void {
      this.elements.dots.forEach((dot) => {
        const isActive = Number(dot.dataset.slide) === this.currentIndex;
        if (isActive) {
          dot.classList.remove("bg-gray-300", "hover:bg-gray-400");
          dot.classList.add("bg-orange-500", "transform", "scale-125");
        } else {
          dot.classList.remove("bg-orange-500", "transform", "scale-125");
          dot.classList.add("bg-gray-300", "hover:bg-gray-400");
        }
      });
    }

    private startAutoSlide(): void {
      this.stopAutoSlide();
      this.autoSlideInterval = window.setInterval(() => {
        this.nextSlide();
      }, 5000);
    }

    private stopAutoSlide(): void {
      if (this.autoSlideInterval) {
        clearInterval(this.autoSlideInterval);
        this.autoSlideInterval = null;
      }
    }

    private resetAutoSlide(): void {
      this.stopAutoSlide();
      this.startAutoSlide();
    }
  }

  // Initialize carousel when DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    new TestimonialsCarousel();
  });
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0.4;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-fade {
    animation: fadeIn 0.8s ease-in-out;
  }

  .testimonial-card {
    transition: all 0.5s ease;
  }

  .testimonial-card:hover {
    transform: translateY(-5px);
    box-shadow:
      0 20px 25px -5px rgba(0, 0, 0, 0.1),
      0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .nav-button:hover {
    background-color: #fa4416c4;
    color: white;
  }

  /* Custom border width for the image */
  .border-3 {
    border-width: 3px;
  }

  /* Ensure smooth transitions */
  .carousel-track {
    transition: transform 0.5s ease-in-out;
  }
</style>
